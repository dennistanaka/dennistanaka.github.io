---
layout: post
title:  "Ruby on Rails Development Environment on Docker"
date:   2020-06-28 20:33:48 +0900
---

<h4>Table of Contents</h4>
* TOC
{:toc}

This article shows an example of how to setup a Ruby on Rails development environment on Docker. The end result is a brand new Rails application that uses MySQL as its database.

I created this on an Ubuntu machine as I was particularly interested in making this work on a Linux environment since that's what I've been used latelly for personal projects and also because this presents a challenge regarding file permissions we don't have to think about when using Docker on a Mac.

This will probably be a permanent work in progress as I may enconunter some issues with this setup after spending more time with it while working on my projects.

## Initial State

We first create a folder for our application and add some files as described above. I will call this app `rails_on_docker`.

```bash
$ mkdir rails_on_docker
$ cd rails_on_docker
```

Create a file named `Dockerfile` in this folder with the following contents:

```dockerfile
FROM ruby:2.7.1

ARG USER_ID
ARG GROUP_ID

RUN curl -sL https://deb.nodesource.com/setup_12.x | bash - \
    && curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list

RUN apt-get update -qq && \
    apt-get install -y build-essential \
                       libpq-dev \
                       nodejs \
                       yarn

RUN mkdir /app
ENV APP_ROOT /app
ENV BUNDLE_PATH /home/appuser/.local/bundle
WORKDIR $APP_ROOT

RUN groupadd appuser && useradd -g appuser -m -d /home/appuser appuser

RUN if [ ${USER_ID:-0} -ne 0 ] && [ ${GROUP_ID:-0} -ne 0 ]; then \
    usermod -u $USER_ID appuser &&\
    groupmod -g $GROUP_ID appuser\
;fi

COPY Gemfile $APP_ROOT/Gemfile
COPY Gemfile.lock $APP_ROOT/Gemfile.lock
RUN bundle install

COPY . $APP_ROOT

RUN chown -R appuser:appuser $APP_ROOT $BUNDLE_PATH

USER appuser
```

### TODO describe the contents of the Dockerfile

Next, add a `docker-compose.yml` file:

```yml
version: '3'
services:
  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306"
    volumes:
      - db-volume:/var/lib/mysql
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USER_ID: ${HOST_UID:-0}
        GROUP_ID: ${HOST_GID:-0}
    command: /bin/bash -c "rm tmp/pids/server.pid;
                           bundle install;
                           yarn install;
                           bundle exec rails db:migrate;
                           bundle exec rails s -p 3000 -b 0.0.0.0"
    tty: true
    stdin_open: true
    volumes:
      - .:/app
      - bundle-volume:/home/appuser/.local/bundle
    ports:
      - "8080:3000"
    depends_on:
      - db
volumes:
  bundle-volume:
    driver: local
  db-volume:
    driver: local
```

Lastly, create an empty `Gemfile.lock` file and also a `Gemfile` with the following content:

```
source 'https://rubygems.org'
gem 'rails', '6.0.3.1'
```

Let's add a `.dockerignore` file now as we will probably need to prevent files from being part of our build at some point:

```bash
.dockerignore
docker-compose.yml
Dockerfile

.git
.gitignore

.ruby-version
README.md

### The lines below were copied from the .gitignore generated by Rails ###

# Ignore bundler config.
/.bundle

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

# Ignore pidfiles, but keep the directory.
/tmp/pids/*
!/tmp/pids/
!/tmp/pids/.keep

# Ignore uploaded files in development.
/storage/*
!/storage/.keep

/public/assets
.byebug_history

# Ignore master key for decrypting credentials and more.
/config/master.key
```

## First Build

Next, we are going to run an initial build of our application. But, before that, let's define some environment variables to be used in the build:

```bash
$ export HOST_UID=1000
$ export HOST_GID=1000
```

### TODO explain why we have to do this

Then, we can finally run:

```bash
$ docker-compose build
```

## Create our Project

Right now, we don't have much, but thanks to the build we run in the previous step, we at least we already have an image containing Ruby on Rails. So, let's create our project:

```bash
$ docker-compose run --rm web bundle exec rails new . --force --database=mysql --webpack --skip-bundle
```

An error like the blow may be shown, but can safely be ignored for now:

```
Could not find gem 'mysql2 (>= 0.4.4)' in any of the gem sources listed in your Gemfile.
```

`rails new` should have added many dependencies to our `Gemfile`. Let's then install those gems:

```bash
$ docker-compose run --rm web bundle install
```

This has installed our dependencies to the `bundle-volume` defined in our `docker-compose.yml` file and this also has populated our `Gemfile.lock`, that will be in a new build we are going to do later.

We can now install Webpacker and the dependencies defined in `package.json`:

```bash
$ docker-compose run --rm web bundle exec rails webpacker:install
```

Let's change some configuration before building a new version of the Docker image.

Edit the following lines in the `config/database.yml` file:

```yml
  password: root
  host: db
```

Allow any hosts to connect by adding the following line to `config/application.rb`:

```ruby
config.hosts.clear
```

And finally rebuild the Docker image:

```bash
$ docker-compose build
```

## Run our Application

Create the local database:

```shell
$ docker-compose run --rm web bundle exec rails db:create
$ docker-compose run --rm web bundle exec rails db:migrate
```

And we can finally start our containers:

```shell
$ docker-compose up
```

We can access our application on `http://localhost:8080`.

## References

[https://docs.docker.com/compose/rails/](https://docs.docker.com/compose/rails/)
[https://qiita.com/yohm/items/047b2e68d008ebb0f001](https://qiita.com/yohm/items/047b2e68d008ebb0f001)
[https://jtreminio.com/blog/running-docker-containers-as-current-host-user/](https://jtreminio.com/blog/running-docker-containers-as-current-host-user/)
[]()
[]()
[]()
[]()


<br>
<hr>
<br>

# New Instructions

Create Dockerfile

```dockerfile
FROM ruby:2.7.1

RUN curl -sL https://deb.nodesource.com/setup_12.x | bash - \
    && curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list

RUN apt-get update -qq && \
    apt-get install -y build-essential \
                       libpq-dev \
                       nodejs \
                       yarn

RUN mkdir /rails_experiments
ENV APP_ROOT /rails_experiments
WORKDIR $APP_ROOT

ADD ./Gemfile $APP_ROOT/Gemfile
ADD ./Gemfile.lock $APP_ROOT/Gemfile.lock

RUN bundle install
ADD . $APP_ROOT
```



Create Gemfile

```
source 'https://rubygems.org'
gem 'rails', '6.0.3.1'
```

Create empty Gemfile.lock
Create docker-compose.yml

```yml
version: '3'
services:
  db:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306"
  web:
    build: .
    command: /bin/bash -c "rm tmp/pids/server.pid;
                           bundle install;
                           yarn install;
                           rails db:migrate;
                           rails s -p 3000 -b 0.0.0.0"
    volumes:
      - .:/rails_experiments
    ports:
      - "8080:3000"
    links:
      - db
```

5. Execute a first build of the image:

```shell
$ docker-compose build
```

6. Create the new Rails project with the host user:

```shell
docker-compose run --rm --user $(id -u):$(id -g) web rails new . --force --database=mysql --skip-bundle
```

An error like the blow may be shown, but can be safely ignored:

```
Could not find gem 'mysql2 (>= 0.4.4)' in any of the gem sources listed in your Gemfile.
```

7. Run `bundle install`, especially to update Gemfile.lock:

```shell
$ docker-compose run --rm web bundle install
```

8. Rebuild the image:

```shell
$ docker-compose build
```

9. Install webpacker:

```shell
$ docker-compose run --rm --user $(id -u):$(id -g) web rails webpacker:install
```

<!-- 10. Rebuild the image:

```shell
$ docker-compose build
``` -->

11. Edit the following lines in the `config/database.yml` file:

```yml
  password: root
  host: db
```

12. Create the local database:

```shell
$ docker-compose run --rm web rails db:create
$ docker-compose run --rm web rails db:migrate
```

13. Allow any hosts to connect by adding the following line to `config/application.rb`:

```ruby
config.hosts.clear
```

14. Rebuild the image:

```shell
$ docker-compose build
```

15. Run the container:

```shell
$ docker-compose up
```

<br>
<hr>
<br>

This is my annotations on how to create a Ruby on Rails development environment on Docker. The contents follow the [official documentation](https://docs.docker.com/compose/rails/) closely with some small changes that made sense to me. All the procedures were executed on a Windows 10 device.

# Prerequisites

You need to have Docker Desktop on Windows installed. You can get it from the [Docker website](https://hub.docker.com/editions/community/docker-ce-desktop-windows). 

# Preparation

First, let's create a new folder for our project:

```bash
$ mkdir rails_on_docker
$ cd rails_on_docker
```

Then, let's create the following empty files in the folder we just created:

* Dockerfile
* Gemfile
* Gemfile.lock
* entrypoint.sh
* docker-compose.yml

Let's first add the following contents to our `Dockerfile`:

```dockerfile
FROM ruby:2.6.5

# Add yarn package repository
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
# https://serverfault.com/questions/644180/what-does-qq-argument-for-apt-get-mean
# The -qq is a flag to apt-get to make it less noisy.
# -qq No output except for errors
# https://askubuntu.com/questions/1160610/gitlab-ci-package-mysql-client-has-no-installation-candidate
# mysql package names for Debian Buster have a default- prefix
RUN apt-get update -qq && apt-get install -y dos2unix nodejs default-mysql-client default-libmysqlclient-dev yarn
RUN mkdir /rails_on_docker
WORKDIR /rails_on_docker
COPY Gemfile /rails_on_docker/Gemfile
COPY Gemfile.lock /rails_on_docker/Gemfile.lock
RUN bundle install
COPY . /rails_on_docker

# Add a script to be executed every time the container starts.
COPY entrypoint.sh /usr/bin/
# https://stackoverflow.com/questions/53165471/building-docker-images-on-windows-entrypoint-script-no-such-file-or-directory
# The entrypoint.sh must use Unix line endings. So, installing and running dos2unix on it avoids errors when running on a Windows host
RUN dos2unix /usr/bin/entrypoint.sh
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 3000

# Start the main process.
CMD ["rails", "server", "-b", "0.0.0.0"]
```

And the following contents to our `Gemfile` (Gemfile.lock can remain empty):

```
source 'https://rubygems.org'
gem 'rails', '~>6'
```

Then let's make sure the entrypoint.sh file has the following contents:

```bash
#!/bin/bash
# https://stackoverflow.com/questions/19622198/what-does-set-e-mean-in-a-bash-script
# -e  Exit immediately if a command exits with a non-zero status.
set -e

# Remove a potentially pre-existing server.pid for Rails.
rm -f /rails_on_docker/tmp/pids/server.pid

# Then exec the container's main process (what's set as CMD in the Dockerfile).
exec "$@"

```

And, finally, these are the contents of `docker-compose.yml`:

```yml
version: '3'
services:
  db:
    # https://hub.docker.com/_/mysql
    image: mysql:5.7
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: railsondocker
    ports:
      - "3306:3306"
  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - .:/rails_on_docker
    ports:
      - "3000:3000"
    depends_on:
      - db
    environment:
      RAILS_ENV: development
```

# Build the Project

```bash
$ docker-compose run web rails new . --force --no-deps --database=mysql
```

Now, let's build the image again:

```bash
$ docker-compose build
```

# Remaining Steps

We now need to update a couple of configurations in the `config\database.yml` file to match our environment. The `default` section will look like this:

```yml
default: &default
  adapter: mysql2
  encoding: utf8mb4
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: root
  password: railsondocker
  host: db
```

Then we can boot the app:

```bash
$ docker-compose up
```

After that, let's open a new terminal and run the command below to create the app's database:

```bash
$ docker-compose run web rake db:create
```

And that's it. You can now access the app on `http://localhost:3000`. Also, you can use adminer to query the database on `http://localhost:8080`.

# TODO

Test these procedures on a Mac and update the post accordingly.
